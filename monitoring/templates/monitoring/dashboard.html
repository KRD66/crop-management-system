{% extends "monitoring/base.html" %}

{% block title %}Dashboard - HarvestPro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<style>
    /* Dashboard Metrics */
    .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .metric-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        background: #f0fdf4;
        color: #16a34a;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .metric-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .metric-label {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 2px;
    }

    .metric-change {
        color: #6b7280;
        font-size: 0.8rem;
    }

    .data-indicator {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #16a34a;
    }

    /* Sections */
    .section {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        position: relative;
    }

    .section h3 {
        font-size: 1.3rem;
        font-weight: 600;
        color: #1f293b;
        margin: 0 0 15px 0;
    }

    .section p {
        color: #6b7280;
        font-size: 0.9rem;
        margin: 0 0 20px 0;
    }

    /* Chart containers */
    .chart-wrapper {
        width: 100%;
        height: 350px;
        position: relative;
        overflow: hidden;
    }

    .chart-wrapper canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }

    /* Grid Layouts */
    .charts-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .activities-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    /* Activity Items */
    .activity-item {
        padding: 15px;
        border-bottom: 1px solid #e5e7eb;
        border-left: 3px solid #16a34a;
        margin-bottom: 8px;
        background: #f9fafb;
        border-radius: 0 8px 8px 0;
        transition: all 0.2s;
    }

    .activity-item:hover {
        background: #f3f4f6;
        transform: translateX(2px);
    }

    .activity-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .activity-item.upcoming {
        border-left-color: #f59e0b;
    }

    .activity-title {
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 5px 0;
    }

    .activity-detail {
        color: #6b7280;
        margin: 0 0 5px 0;
        font-size: 0.9rem;
    }

    .activity-date {
        color: #9ca3af;
        font-size: 0.8rem;
    }

    .status-indicator {
        color: #16a34a;
        font-weight: 600;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .charts-grid,
        .activities-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
    }

    @media (max-width: 768px) {
        .metrics {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .metric-card {
            padding: 15px;
            gap: 12px;
        }
        
        .metric-icon {
            width: 45px;
            height: 45px;
            font-size: 1.3rem;
        }
        
        .metric-value {
            font-size: 1.5rem;
        }
        
        .section {
            padding: 15px;
            margin-bottom: 15px;
        }

        .chart-wrapper {
            height: 250px;
        }
    }

    @media (max-width: 480px) {
        .metrics {
            grid-template-columns: 1fr;
        }

        .metric-card {
            padding: 12px;
            gap: 8px;
        }

        .chart-wrapper {
            height: 200px;
        }

        .activity-item {
            padding: 10px;
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block header_content %}
<h1>Dashboard</h1>
<p>Farm overview and key metrics <span class="status-indicator">â€¢ Live Data</span></p>
{% endblock %}

{% block content %}
<!-- Dashboard Metrics -->
<div class="metrics">
    <div class="metric-card">
        <div class="data-indicator"></div>
        <div class="metric-icon">
            <i class="fas fa-seedling"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Total Harvested (12mo)</div>
            <div class="metric-value">2,847 tons</div>
            <div class="metric-change">Avg 237.3 tons/month</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="data-indicator"></div>
        <div class="metric-icon">
            <i class="fas fa-tractor"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Active Farms</div>
            <div class="metric-value">4</div>
            <div class="metric-change">3 exceeding targets</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="data-indicator"></div>
        <div class="metric-icon">
            <i class="fas fa-warehouse"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Current Inventory</div>
            <div class="metric-value">1,248 tons</div>
            <div class="metric-change">In storage facilities</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="data-indicator"></div>
        <div class="metric-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Yield Efficiency</div>
            <div class="metric-value">87%</div>
            <div class="metric-change">Meeting targets</div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
    <div class="section">
        <h3>Harvest Trends</h3>
        <p>Monthly harvest data over the last 12 months</p>
        <div class="chart-wrapper">
            <canvas id="harvestChart"></canvas>
        </div>
    </div>
    
    <div class="section">
        <h3>Crop Distribution</h3>
        <p>Harvest distribution by crop type</p>
        <div class="chart-wrapper">
            <canvas id="cropChart"></canvas>
        </div>
    </div>
</div>

<div class="section">
    <h3>Yield Performance</h3>
    <p>Expected vs actual yield comparison by farm (last 12 months)</p>
    <div class="chart-wrapper">
        <canvas id="yieldChart"></canvas>
    </div>
</div>

<!-- Recent & Upcoming Harvests -->
<div class="activities-grid">
    <div class="section">
        <h3>Recent Harvests</h3>
        <p>Last 30 days</p>
        
        <div class="activity-item">
            <div class="activity-title">Sunny Valley Farm - Rice field</div>
            <div class="activity-detail">500 tons of Rice</div>
            <div class="activity-date">Sep 13, 2025</div>
        </div>
        
        <div class="activity-item">
            <div class="activity-title">Green Acres - Corn Field A</div>
            <div class="activity-detail">200 tons of Corn</div>
            <div class="activity-date">Sep 13, 2025</div>
        </div>
        
        <div class="activity-item">
            <div class="activity-title">Golden Fields - Wheat Section B</div>
            <div class="activity-detail">85 tons of Wheat</div>
            <div class="activity-date">Sep 10, 2025</div>
        </div>
        
        <div class="activity-item">
            <div class="activity-title">Riverside Farm - Cassava Plot 1</div>
            <div class="activity-detail">45 tons of Cassava</div>
            <div class="activity-date">Sep 8, 2025</div>
        </div>
        
        <div class="activity-item">
            <div class="activity-title">Valley View - Bean Field</div>
            <div class="activity-detail">32 tons of Beans</div>
            <div class="activity-date">Sep 5, 2025</div>
        </div>
    </div>

    <div class="section">
        <h3>Upcoming Harvests</h3>
        <p>Next 60 days</p>
        
        <div class="activity-item upcoming">
            <div class="activity-title">obasanjo farm - Yam Section A</div>
            <div class="activity-detail">Yam - 15.0 hectares</div>
            <div class="activity-date">Expected: Sep 20, 2025</div>
        </div>
        
        <div class="activity-item upcoming">
            <div class="activity-title">anuoluwapo farm - Plantain Grove</div>
            <div class="activity-detail">Plantain - 8.5 hectares</div>
            <div class="activity-date">Expected: Sep 25, 2025</div>
        </div>
        
        <div class="activity-item upcoming">
            <div class="activity-title">Odo Eja Farm - Cocoa Orchard</div>
            <div class="activity-detail">Cocoa - 6.0 hectares</div>
            <div class="activity-date">Expected: Oct 2, 2025</div>
        </div>
        
        <div class="activity-item upcoming">
            <div class="activity-title">obasanjo farm - Wheat Field B</div>
            <div class="activity-detail">Wheat - 25.0 hectares</div>
            <div class="activity-date">Expected: Oct 8, 2025</div>
        </div>
        
        <div class="activity-item upcoming">
            <div class="activity-title">anuoluwapo farm - Rice Paddies</div>
            <div class="activity-detail">Rice - 12.0 hectares</div>
            <div class="activity-date">Expected: Oct 15, 2025</div>
        </div>
        
        <div class="activity-item upcoming">
            <div class="activity-title">obasanjo farm - Corn Section C</div>
            <div class="activity-detail">Corn - 20.0 hectares</div>
            <div class="activity-date">Expected: Nov 5, 2025</div>
        </div>
    </div>
</div>

<div style="text-align: center; color: #9ca3af; font-size: 0.8rem; margin-top: 20px;">
    Data last updated: Sep 14, 2025 14:15
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<!-- Toastr JS for notifications -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
    // Dummy data based on your actual data structure
    const harvestTrends = [
        { month: 'Sep 2024', value: 180 },
        { month: 'Oct 2024', value: 220 },
        { month: 'Nov 2024', value: 350 },
        { month: 'Dec 2024', value: 280 },
        { month: 'Jan 2025', value: 195 },
        { month: 'Feb 2025', value: 240 },
        { month: 'Mar 2025', value: 310 },
        { month: 'Apr 2025', value: 285 },
        { month: 'May 2025', value: 420 },
        { month: 'Jun 2025', value: 380 },
        { month: 'Jul 2025', value: 300 },
        { month: 'Aug 2025', value: 265 }
    ];

    const cropDistribution = [
        { crop: 'rice', quantity: 980, percentage: 34 },
        { crop: 'corn', quantity: 682, percentage: 24 },
        { crop: 'wheat', quantity: 540, percentage: 19 },
        { crop: 'cassava', quantity: 285, percentage: 10 },
        { crop: 'beans', quantity: 198, percentage: 7 },
        { crop: 'plantain', quantity: 142, percentage: 5 },
        { crop: 'yam', value: 85, percentage: 3 }
    ];

    const yieldPerformance = [
        { farm: 'Sunny Valley Farm', expected: 180, actual: 175 },
        { farm: 'Green Acres', expected: 120, actual: 135 },
        { farm: 'Golden Fields', expected: 95, actual: 108 },
        { farm: 'Riverside Farm', expected: 85, actual: 78 }
    ];

    // Check if we have data
    const hasHarvestData = harvestTrends.length > 0 && harvestTrends.some(d => d.value > 0);
    const hasCropData = cropDistribution.length > 0;
    const hasYieldData = yieldPerformance.length > 0;

    // Harvest Trends Chart
    const harvestCtx = document.getElementById('harvestChart').getContext('2d');
    new Chart(harvestCtx, {
        type: 'line',
        data: {
            labels: harvestTrends.map(d => d.month),
            datasets: [{
                label: 'Harvest (tons)',
                data: harvestTrends.map(d => d.value),
                borderColor: '#16a34a',
                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#16a34a',
                pointBorderColor: '#16a34a',
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { color: '#f1f5f9' },
                    ticks: {
                        callback: function(value) {
                            return value + ' tons';
                        }
                    }
                },
                x: {
                    grid: { color: '#f1f5f9' },
                    ticks: { maxRotation: 45, minRotation: 30, autoSkip: false }
                }
            },
            plugins: { 
                legend: { display: true },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Harvest: ' + context.parsed.y + ' tons';
                        }
                    }
                }
            }
        }
    });

    // Crop Distribution Chart
    const cropCtx = document.getElementById('cropChart').getContext('2d');
    new Chart(cropCtx, {
        type: 'doughnut',
        data: {
            labels: cropDistribution.map(d => d.crop.charAt(0).toUpperCase() + d.crop.slice(1)),
            datasets: [{
                data: cropDistribution.map(d => d.percentage),
                backgroundColor: ['#16a34a', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16'],
                borderWidth: 2,
                borderColor: '#ffffff',
                cutout: '60%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'bottom', 
                    labels: { 
                        padding: 20, 
                        usePointStyle: true, 
                        font: { size: 11 },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const crop = cropDistribution[i];
                                    return {
                                        text: `${label}: ${crop.quantity}t (${value}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    } 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const crop = cropDistribution[context.dataIndex];
                            return `${context.label}: ${crop.quantity} tons (${crop.percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Yield Performance Chart
    const yieldCtx = document.getElementById('yieldChart').getContext('2d');
    const maxValue = Math.max(...yieldPerformance.map(d => Math.max(d.expected, d.actual)));
    
    new Chart(yieldCtx, {
        type: 'bar',
        data: {
            labels: yieldPerformance.map(d => d.farm),
            datasets: [
                { 
                    label: 'Expected Yield', 
                    data: yieldPerformance.map(d => d.expected), 
                    backgroundColor: '#e5e7eb', 
                    borderRadius: 4, 
                    maxBarThickness: 60,
                    borderWidth: 1,
                    borderColor: '#d1d5db'
                },
                { 
                    label: 'Actual Yield', 
                    data: yieldPerformance.map(d => d.actual), 
                    backgroundColor: yieldPerformance.map(d => d.actual >= d.expected ? '#16a34a' : '#f59e0b'),
                    borderRadius: 4, 
                    maxBarThickness: 60,
                    borderWidth: 1,
                    borderColor: yieldPerformance.map(d => d.actual >= d.expected ? '#15803d' : '#d97706')
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    beginAtZero: true, 
                    max: maxValue + (maxValue * 0.1), 
                    grid: { color: '#f1f5f9' }, 
                    ticks: { 
                        stepSize: Math.ceil(maxValue / 10),
                        callback: function(value) {
                            return value + ' tons';
                        }
                    } 
                },
                x: { 
                    grid: { display: false },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0
                    }
                }
            },
            plugins: { 
                legend: { 
                    display: true, 
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const farm = yieldPerformance[context.dataIndex];
                            const percentage = farm.expected > 0 ? ((farm.actual / farm.expected) * 100).toFixed(1) : 0;
                            return `${context.dataset.label}: ${context.parsed.y} tons${context.datasetIndex === 1 ? ` (${percentage}% of expected)` : ''}`;
                        }
                    }
                },
                interaction: { intersect: false, mode: 'index' }
            }
        }
    });

    // Initialize toastr
    toastr.options = {
        closeButton: true,
        progressBar: true,
        positionClass: 'toast-top-right',
        timeOut: 3000,
        extendedTimeOut: 1000,
        showEasing: 'swing',
        hideEasing: 'linear',
        showMethod: 'fadeIn',
        hideMethod: 'fadeOut'
    };

    // Show success notification
    document.addEventListener('DOMContentLoaded', function() {
        toastr.success('Dashboard loaded successfully', 'Success');
        
        // Add subtle animations to cards
        const cards = document.querySelectorAll('.metric-card, .section');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.6s ease';
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    });

    console.log('Dashboard loaded with comprehensive data');
    console.log('Total farms:', 4);
    console.log('Total harvest data points:', harvestTrends.length);
    console.log('Crop types represented:', cropDistribution.length);
    console.log('Yield performance data:', yieldPerformance.length);
</script>
{% endblock %}