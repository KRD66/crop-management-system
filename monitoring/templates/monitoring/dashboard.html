{% extends 'monitoring/base.html' %}

{% block title %}Dashboard - HarvestPro{% endblock %}

{% block content %}
<style>
/* General adjustments for all screens */
.metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.metric-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    flex-wrap: wrap;
}

.metric-icon {
    font-size: 2rem;
}

.section {
    padding: 15px;
    margin-bottom: 20px;
    box-sizing: border-box;
    width: 100%;
}

/* Chart containers */
.chart-wrapper {
    width: 100%;
    max-height: 350px; /* Prevents excessive height on desktop */
    overflow: hidden;
    position: relative;
}

/* Charts responsive */
canvas {
    width: 100% !important;
    height: 100% !important;
    display: block;
}

/* Recent and Upcoming Harvests */
.activity-item, div[style*="border-left"] {
    padding: 12px;
    margin-bottom: 8px;
    font-size: 0.9rem;
    overflow-wrap: break-word;
}

/* Tables - horizontal scroll on small screens */
table {
    display: block;
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

thead, tbody, tr {
    display: table;
    width: 100%;
    table-layout: fixed;
}

th, td {
    text-align: left;
    padding: 10px;
    word-wrap: break-word;
}

/* Responsive adjustments for tablets & mobile */
@media (max-width: 1024px) {
    div[style*="grid-template-columns: 2fr 1fr"],
    div[style*="grid-template-columns: 1fr 1fr"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 20px !important;
    }
}

@media (max-width: 768px) {
    .metric-value {
        font-size: 1.3rem !important;
    }
    .metric-label {
        font-size: 0.85rem !important;
    }
    .metric-change {
        font-size: 0.75rem !important;
    }

    .chart-wrapper {
        max-height: 250px !important;
    }

    .section p {
        font-size: 0.85rem !important;
    }
}

@media (max-width: 480px) {
    .metrics {
        grid-template-columns: 1fr !important;
        gap: 12px;
    }

    .chart-wrapper {
        max-height: 200px !important;
    }

    .metric-card {
        padding: 10px !important;
        gap: 8px;
        flex-direction: column;
        align-items: flex-start;
    }

    .metric-icon {
        font-size: 1.8rem !important;
    }

    div[style*="border-left"] {
        padding: 10px !important;
        font-size: 0.8rem !important;
    }
}
</style>

<!-- Dashboard Metrics -->
<div class="metrics">
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-seedling"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Total Harvested</div>
            <div class="metric-value">{{ total_harvested|floatformat:0 }} tons</div>
            <div class="metric-change">+12% from last season</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-tractor"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Active Farms</div>
            <div class="metric-value">{{ active_farms }}</div>
            <div class="metric-change">Across 3 locations</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-warehouse"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Inventory</div>
            <div class="metric-value">{{ total_inventory|floatformat:0 }} tons</div>
            <div class="metric-change">In storage facilities</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Avg Yield Efficiency</div>
            <div class="metric-value">{{ avg_yield_efficiency }}%</div>
            <div class="metric-change">vs expected yield</div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">
    <div class="section">
        <h3>Harvest Trends</h3>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">Monthly harvest data by crop type</p>
        <div class="chart-wrapper">
            <canvas id="harvestChart"></canvas>
        </div>
    </div>
    
    <div class="section">
        <h3>Crop Distribution</h3>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">Distribution of harvested crops by percentage</p>
        <div class="chart-wrapper">
            <canvas id="cropChart"></canvas>
        </div>
    </div>
</div>

<div class="section" style="margin-bottom: 30px;">
    <h3>Yield Performance</h3>
    <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">Expected vs actual yield comparison by farm</p>
    <div class="chart-wrapper">
        <canvas id="yieldChart"></canvas>
    </div>
</div>

<!-- Recent & Upcoming Harvests -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div class="section">
        <h3>Recent Harvests</h3>
        {% for harvest in recent_harvests %}
        <div style="padding: 15px; border-bottom: 1px solid #eee; border-left: 3px solid #10b981;">
            <strong>{{ harvest.field.farm.name }} - {{ harvest.field.name }}</strong><br>
            <span style="color: #666;">{{ harvest.quantity_tons }} tons of {{ harvest.field.crop.name }}</span><br>
            <small style="color: #888;">{{ harvest.harvest_date }}</small>
        </div>
        {% empty %}
        <p style="color: #666; text-align: center; padding: 20px;">No recent harvests found.</p>
        {% endfor %}
    </div>

    <div class="section">
        <h3>Upcoming Harvests</h3>
        {% for field in upcoming_harvests %}
        <div style="padding: 15px; border-bottom: 1px solid #eee; border-left: 3px solid #f59e0b;">
            <strong>{{ field.farm.name }} - {{ field.name }}</strong><br>
            <span style="color: #666;">{{ field.crop.name }}</span><br>
            <small style="color: #888;">Expected: {{ field.expected_harvest_date }}</small>
        </div>
        {% empty %}
        <p style="color: #666; text-align: center; padding: 20px;">No upcoming harvests scheduled.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // Harvest Trends Chart
    const harvestData = {{ harvest_trends|safe }};
    const harvestCtx = document.getElementById('harvestChart').getContext('2d');
    new Chart(harvestCtx, {
        type: 'line',
        data: {
            labels: harvestData.map(d => d.month),
            datasets: [{
                label: 'Harvest (tons)',
                data: harvestData.map(d => d.value),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: '#3b82f6',
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                x: {
                    grid: { color: '#f1f5f9' },
                    ticks: { maxRotation: 45, minRotation: 30, autoSkip: false }
                }
            },
            plugins: { legend: { display: false } }
        }
    });

    // Crop Distribution Chart
    const cropData = {{ crop_distribution|safe }};
    const cropCtx = document.getElementById('cropChart').getContext('2d');
    new Chart(cropCtx, {
        type: 'doughnut',
        data: {
            labels: cropData.map(d => d.crop.charAt(0).toUpperCase() + d.crop.slice(1) + ' ' + d.percentage + '%'),
            datasets: [{
                data: cropData.map(d => d.percentage),
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                borderWidth: 0,
                cutout: '60%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, font: { size: 11 } } }
            }
        }
    });

    // Yield Performance Chart
    const yieldData = {{ yield_performance|safe }};
    const yieldCtx = document.getElementById('yieldChart').getContext('2d');
    new Chart(yieldCtx, {
        type: 'bar',
        data: {
            labels: yieldData.map(d => d.farm),
            datasets: [
                { label: 'Expected Yield', data: yieldData.map(d => d.expected), backgroundColor: '#e5e7eb', borderRadius: 4, maxBarThickness: 60 },
                { label: 'Actual Yield', data: yieldData.map(d => d.actual), backgroundColor: '#10b981', borderRadius: 4, maxBarThickness: 60 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, max: 2800, grid: { color: '#f1f5f9' }, ticks: { stepSize: 650 } },
                x: { grid: { display: false } }
            },
            plugins: { legend: { display: false } },
            interaction: { intersect: false, mode: 'index' }
        }
    });
</script>
{% endblock %}
