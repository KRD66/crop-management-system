{% extends 'monitoring/base.html' %}

{% block title %}Dashboard - HarvestPro{% endblock %}

{% block header_content %}
<h1>Dashboard</h1>
<p>Farm overview and key metrics 
    {% if has_recent_data %}
        <span class="text-green-600">• Live Data</span>
    {% else %}
        <span class="text-yellow-600">• Limited Data</span>
    {% endif %}
</p>
{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard-specific CSS */
    .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        border-left: 4px solid #3b82f6;
        position: relative;
    }

    .metric-card:nth-child(2) { border-left-color: #10b981; }
    .metric-card:nth-child(3) { border-left-color: #f59e0b; }
    .metric-card:nth-child(4) { border-left-color: #8b5cf6; }

    .metric-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        flex-shrink: 0;
    }

    .metric-card:nth-child(1) .metric-icon { background: #3b82f6; }
    .metric-card:nth-child(2) .metric-icon { background: #10b981; }
    .metric-card:nth-child(3) .metric-icon { background: #f59e0b; }
    .metric-card:nth-child(4) .metric-icon { background: #8b5cf6; }

    .metric-content { flex: 1; }
    .metric-value { 
        font-size: 2rem; 
        font-weight: bold; 
        color: #1f2937; 
        margin: 5px 0; 
        line-height: 1; 
    }
    .metric-label { 
        color: #6b7280; 
        font-size: 0.9rem; 
        font-weight: 500; 
    }
    .metric-change { 
        color: #10b981; 
        font-size: 0.8rem; 
        font-weight: 500; 
    }

    /* Data freshness indicator */
    .data-indicator {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10b981;
    }

    .data-indicator.no-data {
        background: #ef4444;
    }

    .data-indicator.limited-data {
        background: #f59e0b;
    }

    /* Sections */
    .section {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        position: relative;
    }

    .section h3 {
        font-size: 1.3rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 15px 0;
    }

    .section p {
        color: #6b7280;
        font-size: 0.9rem;
        margin: 0 0 20px 0;
    }

    /* Chart containers */
    .chart-wrapper {
        width: 100%;
        height: 350px;
        position: relative;
        overflow: hidden;
    }

    .chart-wrapper canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }

    /* Grid Layouts */
    .charts-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .activities-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    /* Activity Items */
    .activity-item {
        padding: 15px;
        border-bottom: 1px solid #e5e7eb;
        border-left: 3px solid #10b981;
        margin-bottom: 8px;
        background: #f9fafb;
        border-radius: 0 8px 8px 0;
        transition: all 0.2s;
    }

    .activity-item:hover {
        background: #f3f4f6;
        transform: translateX(2px);
    }

    .activity-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .activity-item.upcoming {
        border-left-color: #f59e0b;
    }

    .activity-title {
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 5px 0;
    }

    .activity-detail {
        color: #6b7280;
        margin: 0 0 5px 0;
        font-size: 0.9rem;
    }

    .activity-date {
        color: #9ca3af;
        font-size: 0.8rem;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    /* Error State */
    .error-banner {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #b91c1c;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* No data overlay */
    .no-data-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        z-index: 10;
    }

    .no-data-message {
        text-align: center;
        color: #6b7280;
        font-size: 0.9rem;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .charts-grid,
        .activities-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
    }

    @media (max-width: 768px) {
        .metrics { 
            grid-template-columns: 1fr; 
            gap: 12px; 
        }
        
        .metric-card { 
            padding: 1rem; 
            gap: 12px; 
        }
        
        .metric-value { 
            font-size: 1.5rem; 
        }
        
        .section { 
            padding: 15px; 
            margin-bottom: 15px; 
        }

        .chart-wrapper {
            height: 250px;
        }
    }

    @media (max-width: 480px) {
        .metrics {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .chart-wrapper {
            height: 200px;
        }

        .metric-card {
            padding: 10px;
            gap: 8px;
            flex-direction: column;
            align-items: flex-start;
        }

        .metric-icon {
            font-size: 1.8rem;
        }

        .activity-item {
            padding: 10px;
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
{% if error_message %}
<div class="error-banner">
    <i class="fas fa-exclamation-triangle"></i>
    <span>{{ error_message }}</span>
</div>
{% endif %}

<!-- Dashboard Metrics -->
<div class="metrics">
    <div class="metric-card">
        <div class="data-indicator {% if total_harvested == 0 %}no-data{% endif %}"></div>
        <div class="metric-icon">
            <i class="fas fa-seedling"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Total Harvested (12mo)</div>
            <div class="metric-value">{{ total_harvested|floatformat:0 }} tons</div>
            <div class="metric-change">
                {% if total_harvested > 0 %}
                    Avg {{ monthly_avg_harvest|floatformat:1 }} tons/month
                {% else %}
                    No harvest data available
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="data-indicator {% if active_farms == 0 %}no-data{% endif %}"></div>
        <div class="metric-icon">
            <i class="fas fa-tractor"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Active Farms</div>
            <div class="metric-value">{{ active_farms }}</div>
            <div class="metric-change">
                {% if high_performing_farms %}
                    {{ high_performing_farms }} exceeding targets
                {% else %}
                    {{ total_farms }} total farms
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="data-indicator {% if total_inventory == 0 %}limited-data{% endif %}"></div>
        <div class="metric-icon">
            <i class="fas fa-warehouse"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Current Inventory</div>
            <div class="metric-value">{{ total_inventory|floatformat:0 }} tons</div>
            <div class="metric-change">In storage facilities</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="data-indicator {% if avg_yield_efficiency == 0 %}no-data{% endif %}"></div>
        <div class="metric-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Yield Efficiency</div>
            <div class="metric-value">{{ avg_yield_efficiency }}%</div>
            <div class="metric-change">
                {% if avg_yield_efficiency > 100 %}
                    Above expected yield
                {% elif avg_yield_efficiency > 80 %}
                    Meeting targets
                {% elif avg_yield_efficiency > 0 %}
                    Below expectations
                {% else %}
                    No yield data
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
    <div class="section">
        <h3>Harvest Trends</h3>
        <p>Monthly harvest data over the last 12 months</p>
        <div class="chart-wrapper">
            <canvas id="harvestChart"></canvas>
            {% if not has_recent_data %}
            <div class="no-data-overlay">
                <div class="no-data-message">
                    <i class="fas fa-chart-line" style="font-size: 2rem; opacity: 0.3;"></i><br>
                    No harvest data available<br>
                    <small>Start recording harvests to see trends</small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="section">
        <h3>Crop Distribution</h3>
        <p>Harvest distribution by crop type</p>
        <div class="chart-wrapper">
            <canvas id="cropChart"></canvas>
            {% if not crop_distribution %}
            <div class="no-data-overlay">
                <div class="no-data-message">
                    <i class="fas fa-seedling" style="font-size: 2rem; opacity: 0.3;"></i><br>
                    No crop data available<br>
                    <small>Add crops and record harvests</small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="section">
    <h3>Yield Performance</h3>
    <p>Expected vs actual yield comparison by farm (last 12 months)</p>
    <div class="chart-wrapper">
        <canvas id="yieldChart"></canvas>
        {% if not has_recent_data %}
        <div class="no-data-overlay">
            <div class="no-data-message">
                <i class="fas fa-chart-bar" style="font-size: 2rem; opacity: 0.3;"></i><br>
                No yield data available<br>
                <small>Record harvests to track performance</small>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Recent & Upcoming Harvests -->
<div class="activities-grid">
    <div class="section">
        <h3>Recent Harvests</h3>
        <p>Last 30 days</p>
        {% for harvest in recent_harvests %}
        <div class="activity-item">
            <div class="activity-title">{{ harvest.field.farm.name }} - {{ harvest.field.name }}</div>
            <div class="activity-detail">{{ harvest.quantity_tons|floatformat:0 }} tons of {{ harvest.field.crop.name }}</div>
            <div class="activity-date">{{ harvest.harvest_date|date:"M d, Y" }}</div>
        </div>
        {% empty %}
        <div class="empty-state">
            <i class="fas fa-seedling"></i>
            <p>No recent harvests recorded.</p>
            <small>Recent harvest activity will appear here</small>
        </div>
        {% endfor %}
    </div>

    <div class="section">
        <h3>Upcoming Harvests</h3>
        <p>Next 60 days</p>
        {% for field in upcoming_harvests %}
        <div class="activity-item upcoming">
            <div class="activity-title">{{ field.farm.name }} - {{ field.name }}</div>
            <div class="activity-detail">{{ field.crop.name }} - {{ field.area_hectares }} hectares</div>
            <div class="activity-date">Expected: {{ field.expected_harvest_date|date:"M d, Y" }}</div>
        </div>
        {% empty %}
        <div class="empty-state">
            <i class="fas fa-calendar-plus"></i>
            <p>No upcoming harvests scheduled.</p>
            <small>Set expected harvest dates in field management</small>
        </div>
        {% endfor %}
    </div>
</div>

{% if data_last_updated %}
<div style="text-align: center; color: #9ca3af; font-size: 0.8rem; margin-top: 20px;">
    Data last updated: {{ data_last_updated|date:"M d, Y H:i" }}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // Load real data from context (JSON)
    const harvestTrends = {{ harvest_trends|safe }};
    const cropDistribution = {{ crop_distribution_json|safe }};  // Fixed: Use the JSON version
    const yieldPerformance = {{ yield_performance|safe }};

    // Check if we have data
    const hasHarvestData = harvestTrends.length > 0 && harvestTrends.some(d => d.value > 0);
    const hasCropData = cropDistribution.length > 0;
    const hasYieldData = yieldPerformance.length > 0;

    // Debug logging to help troubleshoot
    console.log('Dashboard Debug Info:');
    console.log('Harvest Trends:', harvestTrends);
    console.log('Crop Distribution:', cropDistribution);
    console.log('Yield Performance:', yieldPerformance);
    console.log('Has Data - Harvest:', hasHarvestData, 'Crop:', hasCropData, 'Yield:', hasYieldData);

    // Harvest Trends Chart
    const harvestCtx = document.getElementById('harvestChart').getContext('2d');
    new Chart(harvestCtx, {
        type: 'line',
        data: {
            labels: harvestTrends.map(d => d.month),
            datasets: [{
                label: 'Harvest (tons)',
                data: harvestTrends.map(d => d.value),
                borderColor: '#3b82f6',
                backgroundColor: hasHarvestData ? 'rgba(59, 130, 246, 0.1)' : 'rgba(156, 163, 175, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: '#3b82f6',
                pointRadius: hasHarvestData ? 5 : 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { color: '#f1f5f9' },
                    ticks: {
                        callback: function(value) {
                            return value + ' tons';
                        }
                    }
                },
                x: {
                    grid: { color: '#f1f5f9' },
                    ticks: { maxRotation: 45, minRotation: 30, autoSkip: false }
                }
            },
            plugins: { 
                legend: { display: hasHarvestData },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Harvest: ' + context.parsed.y + ' tons';
                        }
                    }
                }
            },
            elements: {
                line: {
                    borderColor: hasHarvestData ? '#3b82f6' : '#9ca3af'
                }
            }
        }
    });

    // Crop Distribution Chart
    const cropCtx = document.getElementById('cropChart').getContext('2d');
    if (hasCropData && cropDistribution.some(d => d.quantity > 0)) {
        new Chart(cropCtx, {
            type: 'doughnut',
            data: {
                labels: cropDistribution.map(d => d.crop.charAt(0).toUpperCase() + d.crop.slice(1)),
                datasets: [{
                    data: cropDistribution.map(d => d.percentage),
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'],
                    borderWidth: 2,
                    borderColor: '#ffffff',
                    cutout: '60%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { 
                            padding: 20, 
                            usePointStyle: true, 
                            font: { size: 11 },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        return {
                                            text: `${label}: ${value}%`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        } 
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const crop = cropDistribution[context.dataIndex];
                                return `${context.label}: ${crop.quantity} tons (${crop.percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } else {
        // Show empty chart for no data
        new Chart(cropCtx, {
            type: 'doughnut',
            data: {
                labels: ['No Data'],
                datasets: [{
                    data: [100],
                    backgroundColor: ['#e5e7eb'],
                    borderWidth: 0,
                    cutout: '60%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
    }

    // Yield Performance Chart
    const yieldCtx = document.getElementById('yieldChart').getContext('2d');
    if (hasYieldData && yieldPerformance.some(d => d.actual > 0 || d.expected > 0)) {
        const maxValue = Math.max(...yieldPerformance.map(d => Math.max(d.expected, d.actual)));
        
        new Chart(yieldCtx, {
            type: 'bar',
            data: {
                labels: yieldPerformance.map(d => d.farm),
                datasets: [
                    { 
                        label: 'Expected Yield', 
                        data: yieldPerformance.map(d => d.expected), 
                        backgroundColor: '#e5e7eb', 
                        borderRadius: 4, 
                        maxBarThickness: 60,
                        borderWidth: 1,
                        borderColor: '#d1d5db'
                    },
                    { 
                        label: 'Actual Yield', 
                        data: yieldPerformance.map(d => d.actual), 
                        backgroundColor: yieldPerformance.map(d => d.actual >= d.expected ? '#10b981' : '#f59e0b'), 
                        borderRadius: 4, 
                        maxBarThickness: 60,
                        borderWidth: 1,
                        borderColor: yieldPerformance.map(d => d.actual >= d.expected ? '#059669' : '#d97706')
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        max: maxValue + (maxValue * 0.1), 
                        grid: { color: '#f1f5f9' }, 
                        ticks: { 
                            stepSize: Math.ceil(maxValue / 10),
                            callback: function(value) {
                                return value + ' tons';
                            }
                        } 
                    },
                    x: { 
                        grid: { display: false },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    }
                },
                plugins: { 
                    legend: { 
                        display: true, 
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const farm = yieldPerformance[context.dataIndex];
                                const percentage = farm.expected > 0 ? ((farm.actual / farm.expected) * 100).toFixed(1) : 0;
                                return `${context.dataset.label}: ${context.parsed.y} tons${context.datasetIndex === 1 ? ` (${percentage}% of expected)` : ''}`;
                            }
                        }
                    }
                },
                interaction: { intersect: false, mode: 'index' }
            }
        });
    } else {
        // Show empty chart for no data
        new Chart(yieldCtx, {
            type: 'bar',
            data: {
                labels: ['No Data'],
                datasets: [{
                    data: [0],
                    backgroundColor: '#e5e7eb',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 10, grid: { color: '#f1f5f9' } },
                    x: { grid: { display: false } }
                },
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        });
    }

    // Auto-update dashboard data every 5 minutes (only if page is visible)
    let updateInterval;
    
    function updateDashboardMetrics() {
        if (document.visibilityState === 'visible') {
            console.log('Updating dashboard metrics...');
            // Check if we should refresh the page for new data
            fetch(window.location.href, {
                method: 'HEAD',
                cache: 'no-cache'
            }).then(response => {
                if (response.ok) {
                    // Optionally reload page to get fresh data
                    // window.location.reload();
                    console.log('Dashboard data check completed');
                }
            }).catch(error => {
                console.log('Dashboard update check failed:', error);
            });
        }
    }

    function startUpdateInterval() {
        updateInterval = setInterval(updateDashboardMetrics, 300000); // 5 minutes
    }

    function stopUpdateInterval() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    }

    // Handle page visibility changes
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            startUpdateInterval();
        } else {
            stopUpdateInterval();
        }
    });

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Dashboard loaded with real data');
        console.log('Data counts:', {
            harvestTrends: harvestTrends.length,
            cropDistribution: cropDistribution.length,
            yieldPerformance: yieldPerformance.length
        });
        
        // Show appropriate messages based on data availability
        if ({{ has_recent_data|yesno:"true,false" }}) {
            console.log('Dashboard has recent data');
            if (typeof showToast === 'function') {
                showToast('Dashboard loaded with live farm data', 'success');
            }
        } else {
            console.log('Dashboard has no recent data');
            if (typeof showToast === 'function') {
                showToast('Dashboard ready - start recording harvests to see data', 'info');
            }
        }
        
        // Start the update interval
        startUpdateInterval();
        
        // Add click handlers for metric cards (optional)
        document.querySelectorAll('.metric-card').forEach(card => {
            card.addEventListener('click', function() {
                const label = this.querySelector('.metric-label').textContent;
                console.log('Clicked on metric:', label);
                // Could navigate to detailed view
            });
        });
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        stopUpdateInterval();
    });

    // Add some interactive features
    function refreshDashboard() {
        if (typeof showToast === 'function') {
            showToast('Refreshing dashboard data...', 'info');
        }
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }

    // Check if Chart.js is loaded properly
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded! Charts will not display.');
    } else {
        console.log('Chart.js loaded successfully');
    }

    // Optional: Add a refresh button (you can add this to your template)
    // <button onclick="refreshDashboard()" class="btn btn-outline">Refresh Data</button>
</script>

{% endblock %}