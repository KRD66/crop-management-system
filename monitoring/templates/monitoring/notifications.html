{% extends 'monitoring/base.html' %}
{% load static %}

{% block title %}Notifications - HarvestPro{% endblock %}

{% block extra_css %}
<!-- Toastr CSS for green notifications -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<style>
    /* Notification Statistics Cards - MATCHING analytics.html EXACTLY */
    .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .metric-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        background: #f0fdf4; /* Light green bg matching analytics */
        color: #16a34a; /* Green accent */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .metric-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .metric-label {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 2px;
    }

    /* Main Content Area */
    .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }

    .section {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e5e7eb;
    }

    .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #1f293b;
        margin: 0;
    }

    .section-subtitle {
        color: #6b7280;
        font-size: 0.9rem;
        margin: 5px 0 0 0;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-primary {
        background: #16a34a; /* Green accent */
        color: white;
    }
    .btn-primary:hover { background: #15803d; }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }
    .btn-secondary:hover { background: #4b5563; }

    /* Notification Items */
    .notification-item {
        padding: 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 12px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        transition: all 0.2s;
        position: relative;
    }

    .notification-item:hover {
        background: #f9fafb;
        border-color: #d1d5db;
    }

    .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        color: white;
        flex-shrink: 0;
    }

    .notification-content {
        flex: 1;
        min-width: 0;
    }

    .notification-title {
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 5px 0;
        font-size: 1rem;
    }

    .notification-message {
        color: #6b7280;
        margin: 0 0 8px 0;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .notification-meta {
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 0.8rem;
        color: #9ca3af;
    }

    .notification-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-end;
    }

    .priority-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .priority-high {
        background: #fee2e2;
        color: #dc2626;
    }

    .priority-medium {
        background: #fef3c7;
        color: #d97706;
    }

    .priority-low {
        background: #dbeafe;
        color: #2563eb;
    }

    .btn-small {
        padding: 4px 8px;
        font-size: 0.8rem;
        border-radius: 4px;
    }

    /* Notification Types */
    .notification-item[data-type="harvest"] .notification-icon {
        background: #3b82f6;
    }

    .notification-item[data-type="inventory"] .notification-icon {
        background: #ef4444;
    }

    /* Settings Panel */
    .settings-section {
        margin-bottom: 25px;
    }

    .settings-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1f293b;
        margin: 0 0 15px 0;
    }

    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .setting-item:last-child {
        border-bottom: none;
    }

    .setting-label {
        color: #374151;
        font-weight: 500;
    }

    /* Toggle Switch */
    .toggle {
        position: relative;
        width: 50px;
        height: 24px;
        background: #d1d5db;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .toggle.active {
        background: #16a34a; /* Green accent */
    }

    .toggle::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: transform 0.3s;
    }

    .toggle.active::before {
        transform: translateX(26px);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    /* Responsive Design - MATCHED to analytics.html */
    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
    }

    @media (max-width: 768px) {
        .metrics {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .metric-card {
            padding: 15px;
            gap: 12px;
        }
        
        .metric-icon {
            width: 45px;
            height: 45px;
            font-size: 1.3rem;
        }
        
        .metric-value {
            font-size: 1.5rem;
        }
        
        .section {
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .notification-item {
            padding: 12px;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .notification-actions {
            flex-direction: row;
            align-items: center;
            align-self: stretch;
            justify-content: flex-end;
        }
    }

    @media (max-width: 480px) {
        .metrics {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
        }
        
        .notification-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
    }
</style>
{% endblock %}

{% block header_content %}
<h1>Notifications</h1>
<p>Important farm activities</p>
{% endblock %}

{% block content %}
<!-- Messages Display - Aligned to analytics -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; 
             {% if message.tags == 'success' %}background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534;{% endif %}
             {% if message.tags == 'error' %}background: #fef2f2; border: 1px solid #fecaca; color: #dc2626;{% endif %}
             {% if message.tags == 'warning' %}background: #fffbeb; border: 1px solid #fed7aa; color: #d97706;{% endif %}
             {% if message.tags == 'info' %}background: #eff6ff; border: 1px solid #bfdbfe; color: #1d4ed8;{% endif %}">
            <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- Statistics Cards -->
<div class="metrics">
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-bell"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">All Notifications</div>
            <div class="metric-value">{{ total_notifications }}</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Need Attention</div>
            <div class="metric-value">{{ unread_notifications }}</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-fire"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Urgent Items</div>
            <div class="metric-value">{{ high_priority_notifications }}</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-cog"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Notification Types</div>
            <div class="metric-value">{{ notification_types }}</div>
        </div>
    </div>
</div>

<!-- Main Content Grid -->
<div class="content-grid">
    <!-- Recent Notifications -->
    <div class="section">
        <div class="section-header">
            <div>
                <h2 class="section-title">Recent Notifications</h2>
                <p class="section-subtitle">Stay updated with important farm activities</p>
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="showUnread()">Show Unread</button>
                <button class="btn btn-primary" onclick="markAllRead()">Mark All Read</button>
            </div>
        </div>

        <div class="notifications-list">
            {% for notification in notifications %}
                <div class="notification-item" data-type="{{ notification.notification_type }}">
                    <div class="notification-icon">
                        {% if notification.notification_type == 'harvest' %}
                            <i class="fas fa-calendar-check"></i>
                        {% elif notification.notification_type == 'inventory' %}
                            <i class="fas fa-box"></i>
                        {% endif %}
                    </div>
                    <div class="notification-content">
                        <h3 class="notification-title">
                            {% if notification.notification_type == 'harvest' %}
                                Harvest Due Alert
                            {% elif notification.notification_type == 'inventory' %}
                                Low Inventory Alert
                            {% endif %}
                        </h3>
                        <p class="notification-message">
                            {{ notification.message }}
                        </p>
                        <div class="notification-meta">
                            <span><i class="far fa-clock"></i>  {{ notification.created_at|date:"SHORT_DATE_FORMAT" }} </span>
                            <span><i class="fas fa-map-marker-alt"></i> 
                                {% if notification.notification_type == 'harvest' %}
                                    {{ notification.farm.name }}
                                {% elif notification.notification_type == 'inventory' %}
                                    {{ notification.storage_location }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="notification-actions">
                        <span class="priority-badge priority-{{ notification.priority }}">{{ notification.priority }}</span>
                        <div>
                            <button class="btn btn-primary btn-small" onclick="markAsRead(this)">Mark Read</button>
                            <button class="btn btn-secondary btn-small" onclick="deleteNotification(this)">Delete</button>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="empty-state">
                    <i class="fas fa-bell-slash"></i>
                    <p>No notifications available.</p>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Notification Settings -->
    <div class="section">
        <div class="section-header">
            <div>
                <h2 class="section-title">Notification Settings</h2>
                <p class="section-subtitle">Configure your notification preferences</p>
            </div>
        </div>

        <div class="settings-section">
            <h3 class="settings-title">Notification Types</h3>
            <div class="setting-item">
                <span class="setting-label">Harvest Alerts</span>
                <div class="toggle active" onclick="toggleSetting(this)"></div>
            </div>
            <div class="setting-item">
                <span class="setting-label">Low Inventory</span>
                <div class="toggle active" onclick="toggleSetting(this)"></div>
            </div>
        </div>

        <div class="settings-section">
            <h3 class="settings-title">Notification Channels</h3>
            <div class="setting-item">
                <span class="setting-label">Email Notifications</span>
                <div class="toggle active" onclick="toggleSetting(this)"></div>
            </div>
            <div class="setting-item">
                <span class="setting-label">SMS Alerts</span>
                <div class="toggle" onclick="toggleSetting(this)"></div>
            </div>
            <div class="setting-item">
                <span class="setting-label">Push Notifications</span>
                <div class="toggle active" onclick="toggleSetting(this)"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
    // Notification functions
    function markAsRead(button) {
        const notificationItem = button.closest('.notification-item');
        notificationItem.style.opacity = '0.6';
        button.textContent = 'Read';
        button.disabled = true;
        button.classList.add('btn-secondary');
        button.classList.remove('btn-primary');
        
        toastr.success('Notification marked as read', 'Success');
        updateNotificationCounts();
    }

    function deleteNotification(button) {
        const notificationItem = button.closest('.notification-item');
        notificationItem.style.transform = 'translateX(100%)';
        notificationItem.style.opacity = '0';
        
        setTimeout(() => {
            notificationItem.remove();
            updateNotificationCounts();
            toastr.success('Notification deleted', 'Success');
        }, 300);
    }

    function markAllRead() {
        const unreadNotifications = document.querySelectorAll('.notification-item button.btn-primary');
        unreadNotifications.forEach(button => {
            if (button.textContent === 'Mark Read') {
                markAsRead(button);
            }
        });
        toastr.success('All notifications marked as read', 'Success');
    }

    function showUnread() {
        const allNotifications = document.querySelectorAll('.notification-item');
        allNotifications.forEach(item => {
            const markReadBtn = item.querySelector('button.btn-primary');
            if (markReadBtn && markReadBtn.textContent === 'Mark Read') {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
        toastr.info('Showing unread notifications only', 'Info');
    }

    function toggleSetting(toggleElement) {
        toggleElement.classList.toggle('active');
        const settingLabel = toggleElement.parentElement.querySelector('.setting-label').textContent;
        const isActive = toggleElement.classList.contains('active');
        
        toastr.info(`${settingLabel} ${isActive ? 'enabled' : 'disabled'}`, 'Info');
    }

    function updateNotificationCounts() {
        const totalNotifications = document.querySelectorAll('.notification-item').length;
        const unreadNotifications = document.querySelectorAll('.notification-item button.btn-primary').length;
        const highPriorityNotifications = document.querySelectorAll('.priority-high').length;
        
        const metricValues = document.querySelectorAll('.metric-value');
        if (metricValues.length >= 4) {
            metricValues[0].textContent = totalNotifications;
            metricValues[1].textContent = unreadNotifications;
            metricValues[2].textContent = highPriorityNotifications;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        toastr.options = {
            closeButton: true,
            progressBar: true,
            positionClass: 'toast-top-right',
            timeOut: 3000,
            extendedTimeOut: 1000,
            showEasing: 'swing',
            hideEasing: 'linear',
            showMethod: 'fadeIn',
            hideMethod: 'fadeOut'
        };

        // Show Django messages if any
        {% for message in messages %}
            {% if message.tags == 'success' %}
                toastr.success('{{ message|escapejs }}', 'Success');
            {% elif message.tags == 'error' %}
                toastr.error('{{ message|escapejs }}', 'Error');
            {% elif message.tags == 'warning' %}
                toastr.warning('{{ message|escapejs }}', 'Warning');
            {% else %}
                toastr.info('{{ message|escapejs }}', 'Info');
            {% endif %}
        {% empty %}
            toastr.success('Notifications loaded successfully', 'Success');
        {% endfor %}

        updateNotificationCounts();

        // Add subtle animations to cards
        const cards = document.querySelectorAll('.metric-card, .section');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.6s ease';
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });

        // Auto-dismiss Django messages after 5s
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    alert.remove();
                }, 500);
            }, 5000);
        });

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'a':
                        e.preventDefault();
                        markAllRead();
                        break;
                    case 'u':
                        e.preventDefault();
                        showUnread();
                        break;
                }
            }
        });
    });
</script>
{% endblock %}