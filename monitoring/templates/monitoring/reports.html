{% extends 'monitoring/base.html' %}

{% block title %}Reports - HarvestPro{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard Metrics */
    .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        border-left: 4px solid #3b82f6;
    }

    .metric-card:nth-child(2) { border-left-color: #10b981; }
    .metric-card:nth-child(3) { border-left-color: #f59e0b; }
    .metric-card:nth-child(4) { border-left-color: #8b5cf6; }

    .metric-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        flex-shrink: 0;
    }

    .metric-card:nth-child(1) .metric-icon { background: #3b82f6; }
    .metric-card:nth-child(2) .metric-icon { background: #10b981; }
    .metric-card:nth-child(3) .metric-icon { background: #f59e0b; }
    .metric-card:nth-child(4) .metric-icon { background: #8b5cf6; }

    .metric-content { flex: 1; }
    .metric-value { font-size: 2rem; font-weight: bold; color: #1f2937; margin: 5px 0; line-height: 1; }
    .metric-label { color: #6b7280; font-size: 0.9rem; font-weight: 500; }
    .metric-change { color: #10b981; font-size: 0.8rem; font-weight: 500; }

    /* Reports specific styles */
    .report-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border: 1px solid #f1f5f9;
        margin-bottom: 24px;
    }

    .report-section h3 {
        color: #1e293b;
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .report-section p {
        color: #64748b;
        font-size: 0.875rem;
        margin: 0 0 20px 0;
    }

    .report-templates-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .template-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
    }

    .template-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border-color: #3b82f6;
    }

    .template-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .template-title {
        font-weight: 600;
        color: #1e293b;
        font-size: 1.1rem;
        margin-bottom: 4px;
    }

    .template-description {
        color: #64748b;
        font-size: 0.875rem;
        margin-bottom: 16px;
        line-height: 1.5;
    }

    .template-meta {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
    }

    .template-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75rem;
        color: #64748b;
    }

    .template-frequency {
        background: #f1f5f9;
        color: #475569;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .use-template-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
        width: 100%;
    }

    .use-template-btn:hover {
        background: #2563eb;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-group label {
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
    }

    .form-group input,
    .form-group select {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .generate-btn {
        background: #1f2937;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s;
        min-width: 140px;
        justify-content: center;
    }

    .generate-btn:hover {
        background: #111827;
    }

    .generate-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .report-templates-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
    }

    @media (max-width: 768px) {
        .metrics { 
            grid-template-columns: 1fr; 
            gap: 12px; 
        }
        
        .metric-card { 
            padding: 1rem; 
            gap: 12px; 
        }
        
        .metric-value { 
            font-size: 1.5rem; 
        }
        
        .report-section { 
            padding: 15px; 
            margin-bottom: 15px; 
        }

        .report-templates-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .template-card {
            padding: 16px;
        }
    }

    @media (max-width: 480px) {
        .metrics {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .metric-card {
            padding: 10px;
            gap: 8px;
            flex-direction: column;
            align-items: flex-start;
        }

        .metric-icon {
            font-size: 1.8rem;
        }

        .template-card {
            padding: 14px;
        }
        
        .report-section {
            padding: 16px;
        }
    }
</style>
{% endblock %}

{% block header_content %}
<h1>Reports</h1>
<p>Generate and download comprehensive reports</p>
{% endblock %}

{% block content %}
<!-- Reports Overview Metrics -->
<div class="metrics">
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-file-alt"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Available Reports</div>
            <div class="metric-value">{{ available_report_types }}</div>
            <div class="metric-change">Report templates</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-chart-bar"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Generated Reports</div>
            <div class="metric-value">{{ ready_for_download }}</div>
            <div class="metric-change">Ready for download</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-calendar"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">This Month</div>
            <div class="metric-value">{{ this_month_reports }}</div>
            <div class="metric-change">Reports generated</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Data Coverage</div>
            <div class="metric-value">{{ data_coverage|floatformat:0 }}%</div>
            <div class="metric-change">Data completeness</div>
        </div>
    </div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
    <!-- Generate New Report Section -->
    <div class="report-section">
        <h3>
            <i class="fas fa-plus-circle" style="color: #3b82f6;"></i>
            Generate New Report
        </h3>
        <p>Create custom reports based on your data</p>
        
        <form id="generateReportForm" onsubmit="generateReport(event)">
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="reportType">Report Type</label>
                <select id="reportType" name="report_type" required>
                    <option value="" disabled selected>Select report type</option>
                    <option value="monthly_harvest_summary">Monthly Harvest Summary</option>
                    <option value="yield_performance_report">Yield Performance Report</option>
                    <option value="inventory_status_report">Inventory Status Report</option>
                    <option value="farm_productivity_analysis">Farm Productivity Analysis</option>
                </select>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="fromDate">From Date</label>
                    <input type="date" id="fromDate" name="from_date" required>
                </div>
                <div class="form-group">
                    <label for="toDate">To Date</label>
                    <input type="date" id="toDate" name="to_date" required>
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="exportFormat">Export Format</label>
                <select id="exportFormat" name="export_format" required>
                    <option value="pdf">PDF Document</option>
                    <option value="excel">Excel Spreadsheet</option>
                    <option value="csv">CSV File</option>
                </select>
            </div>
            
            <button type="submit" class="generate-btn">
                <i class="fas fa-file-download"></i>
                Generate Report
            </button>
        </form>
    </div>

    <!-- Report Templates Section -->
    <div class="report-section">
        <h3>
            <i class="fas fa-th-large" style="color: #10b981;"></i>
            Report Templates
        </h3>
        <p>Pre-configured report formats</p>
        
        <div style="display: grid; gap: 16px;">
            <div class="template-card" onclick="useTemplate('monthly_harvest_summary')">
                <div class="template-card-header">
                    <div>
                        <div class="template-title">Monthly Harvest Summary</div>
                        <div class="template-description">Comprehensive overview of monthly harvest activities</div>
                    </div>
                </div>
                <div class="template-meta">
                    <div class="template-meta-item">
                        <i class="fas fa-clock"></i>
                        <span class="template-frequency">monthly</span>
                    </div>
                    <div class="template-meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>Last: 2024-08-01</span>
                    </div>
                </div>
                <button class="use-template-btn" onclick="event.stopPropagation(); useTemplate('monthly_harvest_summary')">
                    Use Template
                </button>
            </div>
            
            <div class="template-card" onclick="useTemplate('yield_performance_report')">
                <div class="template-card-header">
                    <div>
                        <div class="template-title">Yield Performance Report</div>
                        <div class="template-description">Detailed analysis of yield vs expectations</div>
                    </div>
                </div>
                <div class="template-meta">
                    <div class="template-meta-item">
                        <i class="fas fa-clock"></i>
                        <span class="template-frequency">quarterly</span>
                    </div>
                    <div class="template-meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>Last: 2024-07-01</span>
                    </div>
                </div>
                <button class="use-template-btn" onclick="event.stopPropagation(); useTemplate('yield_performance_report')">
                    Use Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Additional Report Templates Grid -->
<div class="report-templates-grid">
    <div class="template-card" onclick="useTemplate('inventory_status_report')">
        <div class="template-card-header">
            <div>
                <div class="template-title">Inventory Status Report</div>
                <div class="template-description">Current inventory levels and storage information</div>
            </div>
        </div>
        <div class="template-meta">
            <div class="template-meta-item">
                <i class="fas fa-clock"></i>
                <span class="template-frequency">weekly</span>
            </div>
            <div class="template-meta-item">
                <i class="fas fa-calendar"></i>
                <span>Last: 2024-08-05</span>
            </div>
        </div>
        <button class="use-template-btn" onclick="event.stopPropagation(); useTemplate('inventory_status_report')">
            Use Template
        </button>
    </div>
    
    <div class="template-card" onclick="useTemplate('farm_productivity_analysis')">
        <div class="template-card-header">
            <div>
                <div class="template-title">Farm Productivity Analysis</div>
                <div class="template-description">Productivity metrics across all farms</div>
            </div>
        </div>
        <div class="template-meta">
            <div class="template-meta-item">
                <i class="fas fa-clock"></i>
                <span class="template-frequency">seasonal</span>
            </div>
            <div class="template-meta-item">
                <i class="fas fa-calendar"></i>
                <span>Last: 2024-06-01</span>
            </div>
        </div>
        <button class="use-template-btn" onclick="event.stopPropagation(); useTemplate('farm_productivity_analysis')">
            Use Template
        </button>
    </div>
    
    <div class="template-card" onclick="useTemplate('crop_performance_report')">
        <div class="template-card-header">
            <div>
                <div class="template-title">Crop Performance Report</div>
                <div class="template-description">Analysis of crop yield and quality metrics</div>
            </div>
        </div>
        <div class="template-meta">
            <div class="template-meta-item">
                <i class="fas fa-clock"></i>
                <span class="template-frequency">quarterly</span>
            </div>
            <div class="template-meta-item">
                <i class="fas fa-calendar"></i>
                <span>Last: 2024-07-15</span>
            </div>
        </div>
        <button class="use-template-btn" onclick="event.stopPropagation(); useTemplate('crop_performance_report')">
            Use Template
        </button>
    </div>
    
    <div class="template-card" onclick="useTemplate('financial_summary_report')">
        <div class="template-card-header">
            <div>
                <div class="template-title">Financial Summary Report</div>
                <div class="template-description">Revenue and cost analysis by farm and crop</div>
            </div>
        </div>
        <div class="template-meta">
            <div class="template-meta-item">
                <i class="fas fa-clock"></i>
                <span class="template-frequency">monthly</span>
            </div>
            <div class="template-meta-item">
                <i class="fas fa-calendar"></i>
                <span>Last: 2024-07-31</span>
            </div>
        </div>
        <button class="use-template-btn" onclick="event.stopPropagation(); useTemplate('financial_summary_report')">
            Use Template
        </button>
    </div>
</div>

<!-- Recent Reports Section -->
<div class="report-section">
    <h3>
        <i class="fas fa-history" style="color: #8b5cf6;"></i>
        Recently Generated Reports
    </h3>
    <p>Your latest reports ready for download</p>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
            <thead style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <tr>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Report Name</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Type</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Generated</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Format</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for report in recent_reports %}
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 12px 16px; color: #111827; font-weight: 500;">{{ report.name }}</td>
                    <td style="padding: 12px 16px; color: #6b7280;">{{ report.get_report_type_display|default:report.report_type }}</td>
                    <td style="padding: 12px 16px; color: #6b7280;">{{ report.generated_at|date:"M d, Y" }}</td>
                    <td style="padding: 12px 16px;">
                        <span style="background: 
                            {% if report.export_format == 'pdf' %}#dbeafe; color: #1e40af;
                            {% elif report.export_format == 'excel' %}#dcfce7; color: #166534;
                            {% else %}#fef3c7; color: #92400e;{% endif %}
                            padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 500;">
                            {{ report.export_format|upper }}
                        </span>
                    </td>
                    <td style="padding: 12px 16px;">
                        <div style="display: flex; gap: 8px;">
                            <button onclick="downloadReport('{{ report.name|slugify }}.{{ report.export_format }}')" 
                                    style="background: #f0f9ff; color: #0369a1; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem;" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="viewReport('{{ report.name|slugify }}.{{ report.export_format }}')" 
                                    style="background: #f0fdf4; color: #15803d; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem;" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="padding: 20px; text-align: center; color: #6b7280;">
                        No reports generated yet. Create your first report above!
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 40px; border-radius: 12px; text-align: center; min-width: 300px;">
        <div style="margin-bottom: 20px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #3b82f6;"></i>
        </div>
        <h3 style="margin: 0 0 8px 0; color: #1e293b;">Generating Report</h3>
        <p style="margin: 0; color: #64748b; font-size: 0.875rem;">Please wait while we prepare your report...</p>
        <div style="width: 100%; height: 4px; background: #f1f5f9; border-radius: 2px; margin-top: 20px; overflow: hidden;">
            <div id="progressBar" style="width: 0%; height: 100%; background: #3b82f6; transition: width 0.3s ease; border-radius: 2px;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Report generation functionality
    function generateReport(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const reportType = formData.get('report_type');
        const fromDate = formData.get('from_date');
        const toDate = formData.get('to_date');
        const exportFormat = formData.get('export_format');
        
        if (!reportType || !fromDate || !toDate || !exportFormat) {
            alert('Please fill in all required fields');
            return;
        }
        
        if (new Date(fromDate) > new Date(toDate)) {
            alert('From date must be before to date');
            return;
        }
        
        // Show loading modal
        showLoadingModal();
        
        // Add ajax flag to form data
        formData.append('ajax', '1');
        
        // FIXED: Post to /reports/ instead of /reports/generate/
        fetch('/reports/', {  // <-- This was /reports/generate/
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            if (response.headers.get('content-type')?.includes('application/json')) {
                return response.json();
            } else {
                // Handle direct download if no JSON
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `report_${Date.now()}.${exportFormat}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    return { success: true, message: 'Report downloaded successfully!' };
                });
            }
        })
        .then(data => {
            hideLoadingModal();
            
            if (data.success) {
                showToast(data.message, 'success');
                
                if (data.download_url) {
                    // Trigger automatic download
                    setTimeout(() => {
                        window.location.href = data.download_url;
                    }, 1000);
                }
                
                // Reset form and refresh page to show updated reports
                event.target.reset();
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showToast(data.error || 'Error generating report', 'error');
            }
        })
        .catch(error => {
            hideLoadingModal();
            console.error('Error:', error);
            showToast('Error generating report. Please try again.', 'error');
        });
    }

    function useTemplate(templateType) {
        // Auto-fill the form with template data
        const reportTypeSelect = document.getElementById('reportType');
        const exportFormatSelect = document.getElementById('exportFormat');
        const fromDateInput = document.getElementById('fromDate');
        const toDateInput = document.getElementById('toDate');
        
        // Set report type
        reportTypeSelect.value = templateType;
        
        // Set default dates based on template (wider range for testing)
        const today = new Date();
        const yearStart = new Date(today.getFullYear() - 1, 0, 1);  // Jan 1 last year for broader coverage
        
        switch(templateType) {
            case 'monthly_harvest_summary':
                fromDateInput.value = new Date(today.getFullYear(), today.getMonth() - 1, 1).toISOString().split('T')[0];
                toDateInput.value = today.toISOString().split('T')[0];
                exportFormatSelect.value = 'csv';  // CSV for easy testing
                break;
            case 'yield_performance_report':
                fromDateInput.value = yearStart.toISOString().split('T')[0];  // Wider: last year start
                toDateInput.value = today.toISOString().split('T')[0];
                exportFormatSelect.value = 'excel';
                break;
            case 'inventory_status_report':
                fromDateInput.value = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];  // This month
                toDateInput.value = today.toISOString().split('T')[0];
                exportFormatSelect.value = 'csv';
                break;
            default:
                fromDateInput.value = yearStart.toISOString().split('T')[0];  // Default to broad range
                toDateInput.value = today.toISOString().split('T')[0];
                exportFormatSelect.value = 'csv';
        }
        
        // Scroll to form
        document.getElementById('generateReportForm').scrollIntoView({ behavior: 'smooth' });
    }

    function showLoadingModal() {
        document.getElementById('loadingModal').style.display = 'flex';
        document.getElementById('progressBar').style.width = '0%';
    }

    function hideLoadingModal() {
        document.getElementById('loadingModal').style.display = 'none';
    }

    function downloadReport(reportId) {
        window.location.href = `/reports/download/${reportId}/`;
        showToast('Downloading report...', 'info');
    }
    
    function viewReport(reportId) {
        // Open in new tab for viewing
        window.open(`/reports/download/${reportId}/`, '_blank');
        showToast('Opening report...', 'info');
    }

    // Set default dates on page load (wider range for testing your data)
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        const yearStart = new Date(today.getFullYear() - 1, 0, 1);  // Jan 1, 2024 for broad coverage
        const now = today.toISOString().split('T')[0];
        
        document.getElementById('fromDate').value = yearStart.toISOString().split('T')[0];  // e.g., 2024-01-01
        document.getElementById('toDate').value = now;  // e.g., 2025-09-12
        
        showToast('Reports page loaded with broad date range (2024-01-01 to today) for testing', 'success');
    });

    // Validate date range
    document.getElementById('toDate').addEventListener('change', function() {
        const fromDate = document.getElementById('fromDate').value;
        const toDate = this.value;
        
        if (fromDate && toDate && new Date(fromDate) > new Date(toDate)) {
            alert('To date must be after from date');
            this.value = '';
        }
    });

    document.getElementById('fromDate').addEventListener('change', function() {
        const fromDate = this.value;
        const toDate = document.getElementById('toDate').value;
        
        if (fromDate && toDate && new Date(fromDate) > new Date(toDate)) {
            alert('From date must be before to date');
            document.getElementById('toDate').value = '';
        }
    });
</script>
{% endblock %}