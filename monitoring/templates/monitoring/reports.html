{% extends 'monitoring/base.html' %}
{% load static %}

{% block title %}Reports - HarvestPro{% endblock %}

{% block extra_css %}
<!-- Toastr CSS for green notifications -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<style>
    /* Dashboard Metrics - MATCHING analytics.html EXACTLY */
    .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .metric-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        background: #f0fdf4; /* Light green bg matching analytics */
        color: #16a34a; /* Green accent */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .metric-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .metric-label {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 2px;
    }

    .metric-change {
        color: #6b7280;
        font-size: 0.8rem;
    }

    /* Reports specific styles */
    .report-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border: 1px solid #f1f5f9;
        margin-bottom: 20px;
    }

    .report-section h3 {
        color: #1e293b;
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .report-section p {
        color: #64748b;
        font-size: 0.875rem;
        margin: 0 0 20px 0;
    }

    .report-templates-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .template-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
    }

    .template-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border-color: #16a34a; /* Green accent */
    }

    .template-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .template-title {
        font-weight: 600;
        color: #1e293b;
        font-size: 1.1rem;
        margin-bottom: 4px;
    }

    .template-description {
        color: #64748b;
        font-size: 0.875rem;
        margin-bottom: 16px;
        line-height: 1.5;
    }

    .template-meta {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
    }

    .template-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75rem;
        color: #64748b;
    }

    .template-frequency {
        background: #f0fdf4; /* Light green bg */
        color: #16a34a; /* Green accent */
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .use-template-btn {
        background: #16a34a; /* Green accent */
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
        width: 100%;
    }

    .use-template-btn:hover {
        background: #15803d;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-group label {
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
    }

    .form-group input,
    .form-group select {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #16a34a; /* Green accent */
        box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }

    .generate-btn {
        background: #1f2937;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s;
        min-width: 140px;
        justify-content: center;
    }

    .generate-btn:hover {
        background: #111827;
    }

    .generate-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }

    /* Status badges for reports */
    .status-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    .status-generated { background: #f0fdf4; color: #16a34a; }
    .status-failed { background: #fef2f2; color: #dc2626; }
    .status-pending { background: #fef3c7; color: #d97706; }

    /* Responsive Design - MATCHED to analytics.html */
    @media (max-width: 1024px) {
        .report-templates-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .form-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .metrics {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .metric-card {
            padding: 15px;
            gap: 12px;
        }
        
        .metric-icon {
            width: 45px;
            height: 45px;
            font-size: 1.3rem;
        }
        
        .metric-value {
            font-size: 1.5rem;
        }
        
        .report-section {
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .report-templates-grid {
            gap: 15px;
        }
        
        .template-card {
            padding: 16px;
        }
    }

    @media (max-width: 480px) {
        .metrics {
            grid-template-columns: 1fr;
        }
        
        .metric-card {
            padding: 12px;
            gap: 8px;
        }
        
        .metric-value {
            font-size: 1.3rem;
        }
        
        .report-section {
            padding: 12px;
        }
        
        .template-card {
            padding: 14px;
        }
    }
</style>
{% endblock %}

{% block header_content %}
<h1>Reports</h1>
<p>Generate and download comprehensive reports</p>
{% endblock %}

{% block content %}
<!-- Messages Display - Aligned to analytics -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; 
             {% if message.tags == 'success' %}background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534;{% endif %}
             {% if message.tags == 'error' %}background: #fef2f2; border: 1px solid #fecaca; color: #dc2626;{% endif %}
             {% if message.tags == 'warning' %}background: #fffbeb; border: 1px solid #fed7aa; color: #d97706;{% endif %}
             {% if message.tags == 'info' %}background: #eff6ff; border: 1px solid #bfdbfe; color: #1d4ed8;{% endif %}">
            <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- Reports Overview Metrics -->
<div class="metrics">
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-file-alt"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Available Reports</div>
            <div class="metric-value">{{ available_report_types }}</div>
            <div class="metric-change">Report templates</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-chart-bar"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Generated Reports</div>
            <div class="metric-value">{{ ready_for_download }}</div>
            <div class="metric-change">Ready for download</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-calendar"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">This Month</div>
            <div class="metric-value">{{ this_month_reports }}</div>
            <div class="metric-change">Reports generated</div>
        </div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="metric-content">
            <div class="metric-label">Data Coverage</div>
            <div class="metric-value">{{ data_coverage|floatformat:0 }}%</div>
            <div class="metric-change">Data completeness</div>
        </div>
    </div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <!-- Generate New Report Section -->
    <div class="report-section">
        <h3>
            <i class="fas fa-plus-circle" style="color: #16a34a;"></i>
            Generate New Report
        </h3>
        <p>Create custom reports based on your data</p>
        
        <form id="generateReportForm" onsubmit="generateReport(event)">
            {% csrf_token %}
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="reportType">Report Type</label>
                <select id="reportType" name="report_type" required>
                    <option value="" disabled selected>Select report type</option>
                    <option value="monthly_harvest_summary">Monthly Harvest Summary</option>
                    <option value="yield_performance_report">Yield Performance Report</option>
                    <option value="inventory_status_report">Inventory Status Report</option>
                    <option value="farm_productivity_analysis">Farm Productivity Analysis</option>
                </select>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="fromDate">From Date</label>
                    <input type="date" id="fromDate" name="from_date" required>
                </div>
                <div class="form-group">
                    <label for="toDate">To Date</label>
                    <input type="date" id="toDate" name="to_date" required>
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="exportFormat">Export Format</label>
                <select id="exportFormat" name="export_format" required>
                    <option value="pdf">PDF Document</option>
                    <option value="excel">Excel Spreadsheet</option>
                    <option value="csv">CSV File</option>
                </select>
            </div>
            
            <button type="submit" class="generate-btn">
                <i class="fas fa-file-download"></i>
                Generate Report
            </button>
        </form>
    </div>

    <!-- Report Templates Section -->
    <div class="report-section">
        <h3>
            <i class="fas fa-th-large" style="color: #16a34a;"></i>
            Report Templates
        </h3>
        <p>Pre-configured report formats</p>
        
        <div style="display: grid; gap: 16px;">
            <div class="template-card" onclick="useTemplate('monthly_harvest_summary')">
                <div class="template-card-header">
                    <div>
                        <div class="template-title">Monthly Harvest Summary</div>
                        <div class="template-description">Comprehensive overview of monthly harvest activities</div>
                    </div>
                </div>
                <div class="template-meta">
                    <div class="template-meta-item">
                        <i class="fas fa-clock"></i>
                        <span class="template-frequency">monthly</span>
                    </div>
                    <div class="template-meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>Last: 2024-08-01</span>
                    </div>
                </div>
                <button class="use-template-btn" onclick="event.stopPropagation(); useTemplate('monthly_harvest_summary')">
                    Use Template
                </button>
            </div>
            
            <div class="template-card" onclick="useTemplate('yield_performance_report')">
                <div class="template-card-header">
                    <div>
                        <div class="template-title">Yield Performance Report</div>
                        <div class="template-description">Detailed analysis of yield vs expectations</div>
                    </div>
                </div>
                <div class="template-meta">
                    <div class="template-meta-item">
                        <i class="fas fa-clock"></i>
                        <span class="template-frequency">quarterly</span>
                    </div>
                    <div class="template-meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>Last: 2024-07-01</span>
                    </div>
                </div>
                <button class="use-template-btn" onclick="event.stopPropagation(); useTemplate('yield_performance_report')">
                    Use Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Additional Report Templates Grid -->
<div class="report-templates-grid">
    <div class="template-card" onclick="useTemplate('inventory_status_report')">
        <div class="template-card-header">
            <div>
                <div class="template-title">Inventory Status Report</div>
                <div class="template-description">Current inventory levels and storage information</div>
            </div>
        </div>
        <div class="template-meta">
            <div class="template-meta-item">
                <i class="fas fa-clock"></i>
                <span class="template-frequency">weekly</span>
            </div>
            <div class="template-meta-item">
                <i class="fas fa-calendar"></i>
                <span>Last: 2024-08-05</span>
            </div>
        </div>
        <button class="use-template-btn" onclick="event.stopPropagation(); useTemplate('inventory_status_report')">
            Use Template
        </button>
    </div>
    
    <div class="template-card" onclick="useTemplate('farm_productivity_analysis')">
        <div class="template-card-header">
            <div>
                <div class="template-title">Farm Productivity Analysis</div>
                <div class="template-description">Productivity metrics across all farms</div>
            </div>
        </div>
        <div class="template-meta">
            <div class="template-meta-item">
                <i class="fas fa-clock"></i>
                <span class="template-frequency">seasonal</span>
            </div>
            <div class="template-meta-item">
                <i class="fas fa-calendar"></i>
                <span>Last: 2024-06-01</span>
            </div>
        </div>
        <button class="use-template-btn" onclick="event.stopPropagation(); useTemplate('farm_productivity_analysis')">
            Use Template
        </button>
    </div>
    
    <div class="template-card" onclick="useTemplate('crop_performance_report')">
        <div class="template-card-header">
            <div>
                <div class="template-title">Crop Performance Report</div>
                <div class="template-description">Analysis of crop yield and quality metrics</div>
            </div>
        </div>
        <div class="template-meta">
            <div class="template-meta-item">
                <i class="fas fa-clock"></i>
                <span class="template-frequency">quarterly</span>
            </div>
            <div class="template-meta-item">
                <i class="fas fa-calendar"></i>
                <span>Last: 2024-07-15</span>
            </div>
        </div>
        <button class="use-template-btn" onclick="event.stopPropagation(); useTemplate('crop_performance_report')">
            Use Template
        </button>
    </div>
    
    <div class="template-card" onclick="useTemplate('financial_summary_report')">
        <div class="template-card-header">
            <div>
                <div class="template-title">Financial Summary Report</div>
                <div class="template-description">Revenue and cost analysis by farm and crop</div>
            </div>
        </div>
        <div class="template-meta">
            <div class="template-meta-item">
                <i class="fas fa-clock"></i>
                <span class="template-frequency">monthly</span>
            </div>
            <div class="template-meta-item">
                <i class="fas fa-calendar"></i>
                <span>Last: 2024-07-31</span>
            </div>
        </div>
        <button class="use-template-btn" onclick="event.stopPropagation(); useTemplate('financial_summary_report')">
            Use Template
        </button>
    </div>
</div>

<!-- Recent Reports Section -->
<div class="report-section">
    <h3>
        <i class="fas fa-history" style="color: #16a34a;"></i>
        Recently Generated Reports
    </h3>
    <p>Your latest reports ready for download</p>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; margin-top: 16px;">
            <thead style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <tr>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Report Name</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Type</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Generated</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Format</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Status</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for report in recent_reports %}
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 12px 16px; color: #111827; font-weight: 500;">{{ report.name }}</td>
                    <td style="padding: 12px 16px; color: #6b7280;">{{ report.get_report_type_display|default:report.report_type }}</td>
                    <td style="padding: 12px 16px; color: #6b7280;">{{ report.generated_at|date:"M d, Y" }}</td>
                    <td style="padding: 12px 16px;">
                        <span style="background: 
                            {% if report.export_format == 'pdf' %}#eff6ff; color: #1d4ed8;
                            {% elif report.export_format == 'excel' %}#f0fdf4; color: #16a34a;
                            {% else %}#fef3c7; color: #92400e;{% endif %}
                            padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 500;">
                            {{ report.export_format|upper }}
                        </span>
                    </td>
                    <td style="padding: 12px 16px;">
                        <span class="status-badge status-{{ report.status }}">{{ report.get_status_display|default:report.status|title }}</span>
                    </td>
                    <td style="padding: 12px 16px;">
                        <div style="display: flex; gap: 8px;">
                            {% if report.status == 'generated' and report.file %}
                                <button onclick="downloadReport({{ report.id }})" 
                                        style="background: #f0f9ff; color: #0369a1; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem;" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button onclick="viewReport({{ report.id }})" 
                                        style="background: #f0fdf4; color: #16a34a; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem;" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                            {% else %}
                                <span style="color: #6b7280; font-size: 0.75rem;">Not ready</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="padding: 20px; text-align: center; color: #6b7280;">
                        No reports generated yet. Create your first report above!
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 40px; border-radius: 12px; text-align: center; min-width: 300px;">
        <div style="margin-bottom: 20px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #16a34a;"></i>
        </div>
        <h3 style="margin: 0 0 8px 0; color: #1e293b;">Generating Report</h3>
        <p style="margin: 0; color: #64748b; font-size: 0.875rem;">Please wait while we prepare your report...</p>
        <div style="width: 100%; height: 4px; background: #f1f5f9; border-radius: 2px; margin-top: 20px; overflow: hidden;">
            <div id="progressBar" style="width: 0%; height: 100%; background: #16a34a; transition: width 0.3s ease; border-radius: 2px;"></div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<!-- Toastr JS for notifications -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
    
document.addEventListener('DOMContentLoaded', function() {
    // Toastr options
    toastr.options = {
        closeButton: true,
        progressBar: true,
        positionClass: 'toast-top-right',
        timeOut: 4000,
        extendedTimeOut: 1000,
        showEasing: 'swing',
        hideEasing: 'linear',
        showMethod: 'fadeIn',
        hideMethod: 'fadeOut'
    };
    
    toastr.success('Reports page loaded', 'Success');

    // Set default dates
    const today = new Date();
    const yearStart = new Date(today.getFullYear() - 1, 0, 1);
    document.getElementById('fromDate').value = yearStart.toISOString().split('T')[0];
    document.getElementById('toDate').value = today.toISOString().split('T')[0];
});

// Simple report generation function
function generateReport(event) {
    event.preventDefault();
    console.log('Generate report called');
    
    const form = event.target;
    const formData = new FormData(form);
    const reportType = formData.get('report_type');
    const fromDate = formData.get('from_date');
    const toDate = formData.get('to_date');
    const exportFormat = formData.get('export_format');
    
    console.log('Form data:', { reportType, fromDate, toDate, exportFormat });
    
    // Basic validation
    if (!reportType || !fromDate || !toDate || !exportFormat) {
        toastr.error('Please fill in all required fields', 'Error');
        return;
    }
    
    if (new Date(fromDate) > new Date(toDate)) {
        toastr.error('From date must be before to date', 'Error');
        return;
    }
    
    // Show loading
    showLoadingModal();
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    
    // Add AJAX flag
    formData.append('ajax', '1');
    
    console.log('Sending AJAX request...');
    
    fetch('/reports/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        console.log('Response received:', response);
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers.get('content-type'));
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        hideLoadingModal();
        
        // Re-enable form
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
        
        if (data.success) {
            toastr.success(data.message || 'Report generated successfully!', 'Success');
            
            if (data.report_id) {
                // Auto download after a short delay
                setTimeout(() => {
                    console.log('Starting auto-download for report ID:', data.report_id);
                    downloadReport(data.report_id);
                }, 1000);
                
                // Reload page after download starts to refresh the table
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        } else {
            toastr.error(data.error || 'Unknown error occurred', 'Error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideLoadingModal();
        
        // Re-enable form
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
        
        toastr.error(`Error generating report: ${error.message}`, 'Error');
    });
}

// Template selection
function useTemplate(templateType) {
    console.log('Using template:', templateType);
    
    const reportTypeSelect = document.getElementById('reportType');
    const exportFormatSelect = document.getElementById('exportFormat');
    const fromDateInput = document.getElementById('fromDate');
    const toDateInput = document.getElementById('toDate');
    
    reportTypeSelect.value = templateType;
    
    const today = new Date();
    const yearStart = new Date(today.getFullYear() - 1, 0, 1);
    
    switch(templateType) {
        case 'monthly_harvest_summary':
            fromDateInput.value = new Date(today.getFullYear(), today.getMonth() - 1, 1).toISOString().split('T')[0];
            toDateInput.value = today.toISOString().split('T')[0];
            exportFormatSelect.value = 'csv';
            break;
        case 'yield_performance_report':
            fromDateInput.value = yearStart.toISOString().split('T')[0];
            toDateInput.value = today.toISOString().split('T')[0];
            exportFormatSelect.value = 'excel';
            break;
        case 'inventory_status_report':
            fromDateInput.value = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            toDateInput.value = today.toISOString().split('T')[0];
            exportFormatSelect.value = 'csv';
            break;
        default:
            fromDateInput.value = yearStart.toISOString().split('T')[0];
            toDateInput.value = today.toISOString().split('T')[0];
            exportFormatSelect.value = 'csv';
    }
    
    document.getElementById('generateReportForm').scrollIntoView({ behavior: 'smooth' });
    toastr.info(`Selected ${templateType.replace(/_/g, ' ').toLowerCase()} template`, 'Info');
}

// Modal controls
function showLoadingModal() {
    const modal = document.getElementById('loadingModal');
    if (modal) {
        modal.style.display = 'flex';
        document.getElementById('progressBar').style.width = '20%';
        
        setTimeout(() => {
            document.getElementById('progressBar').style.width = '60%';
        }, 500);
        
        setTimeout(() => {
            document.getElementById('progressBar').style.width = '90%';
        }, 1000);
    }
}

function hideLoadingModal() {
    const modal = document.getElementById('loadingModal');
    if (modal) {
        document.getElementById('progressBar').style.width = '100%';
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
}

// Download functions
function downloadReport(reportId) {
    console.log('Downloading report ID:', reportId);
    const url = `/reports/download/${reportId}/`;
    window.location.href = url;
    toastr.info('Starting download...', 'Info');
}

function viewReport(reportId) {
    window.open(`/reports/download/${reportId}/`, '_blank');
    toastr.info('Opening report...', 'Info');
}

// Date validation
document.getElementById('toDate').addEventListener('change', function() {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = this.value;
    if (fromDate && toDate && new Date(fromDate) > new Date(toDate)) {
        toastr.error('To date must be after from date', 'Error');
        this.value = '';
    }
});

document.getElementById('fromDate').addEventListener('change', function() {
    const fromDate = this.value;
    const toDate = document.getElementById('toDate').value;
    if (fromDate && toDate && new Date(fromDate) > new Date(toDate)) {
        toastr.error('From date must be before to date', 'Error');
        document.getElementById('toDate').value = '';
    }
});

</script>
{% endblock %}