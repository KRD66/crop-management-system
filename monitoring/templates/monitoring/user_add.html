{% extends 'monitoring/base.html' %}

{% block title %}Add User - HarvestPro{% endblock %}

{% block header_content %}
<h1>User Management</h1>
<p>Create a new user account with appropriate permissions</p>
{% endblock %}

{% block extra_css %}
<style>
    /* Modal styles matching inventory design */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 20px;
        display: flex;
    }

    .modal-container {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        position: relative;
    }

    .modal-body {
        padding: 24px;
        max-height: calc(90vh - 140px);
        overflow-y: auto;
    }

    .form-grid {
        display: grid;
        gap: 20px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-label {
        font-weight: 600;
        color: #111827;
        font-size: 0.875rem;
    }

    .form-input, .form-select {
        padding: 10px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 0.875rem;
        background: #f9fafb;
        transition: all 0.2s;
        width: 100%;
        box-sizing: border-box;
    }

    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 8px center;
        background-repeat: no-repeat;
        background-size: 16px;
        padding-right: 40px;
        cursor: pointer;
    }

    .error {
        color: #dc2626;
        font-size: 0.8rem;
        margin-top: 4px;
    }

    .form-input.error, .form-select.error {
        border-color: #dc2626;
    }

    /* Button styles matching inventory */
    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-primary {
        background: #111827;
        color: white;
    }

    .btn-primary:hover {
        background: #374151;
    }

    .btn-secondary {
        background: white;
        color: #374151;
        border: 2px solid #e5e7eb;
    }

    .btn-secondary:hover {
        background: #f9fafb;
        border-color: #d1d5db;
    }

    .close-btn {
        position: absolute; 
        top: 16px; 
        right: 20px; 
        background: none; 
        border: none; 
        font-size: 1.5rem; 
        color: #9ca3af; 
        cursor: pointer; 
        line-height: 1;
        transition: color 0.2s;
    }

    .close-btn:hover {
        color: #374151;
    }

    /* Modal footer */
    .modal-footer {
        display: flex; 
        gap: 12px; 
        justify-content: flex-end; 
        margin-top: 20px;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .modal-overlay {
            padding: 10px;
        }
        
        .modal-container {
            max-height: calc(100vh - 20px);
            max-width: 95%;
        }
        
        .modal-footer {
            flex-direction: column-reverse;
        }
        
        .btn {
            width: 100%;
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .modal-container {
            max-width: 100%;
            margin: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h3 style="margin: 0; color: #111827; font-size: 1.25rem;">Add New User</h3>
            <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 0.875rem;">Create a new user account with appropriate permissions</p>
            <a href="{% url 'monitoring:user_management' %}" class="close-btn">&times;</a>
        </div>
        
        <div class="modal-body">
            <form class="form-grid" method="POST" id="addUserForm">
                {% csrf_token %}
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">First Name</label>
                        <input type="text" 
                               class="form-input {% if form.first_name.errors %}error{% endif %}" 
                               name="first_name" 
                               id="id_first_name"
                               placeholder="John"
                               value="{{ form.first_name.value|default:'' }}">
                        {% if form.first_name.errors %}
                            {% for error in form.first_name.errors %}
                                <div class="error">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" 
                               class="form-input {% if form.email.errors %}error{% endif %}" 
                               name="email" 
                               id="id_email"
                               placeholder="john.doe@farm.com"
                               value="{{ form.email.value|default:'' }}">
                        {% if form.email.errors %}
                            {% for error in form.email.errors %}
                                <div class="error">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" 
                               class="form-input {% if form.username.errors %}error{% endif %}" 
                               name="username" 
                               id="id_username"
                               placeholder="johndoe"
                               value="{{ form.username.value|default:'' }}">
                        {% if form.username.errors %}
                            {% for error in form.username.errors %}
                                <div class="error">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Last Name</label>
                        <input type="text" 
                               class="form-input {% if form.last_name.errors %}error{% endif %}" 
                               name="last_name" 
                               id="id_last_name"
                               placeholder="Doe"
                               value="{{ form.last_name.value|default:'' }}">
                        {% if form.last_name.errors %}
                            {% for error in form.last_name.errors %}
                                <div class="error">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-select {% if form.role.errors %}error{% endif %}" 
                                name="role" 
                                id="id_role">
                            <option value="">Select role</option>
                            {% for value, label in form.role.field.choices %}
                                <option value="{{ value }}" {% if form.role.value == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if form.role.errors %}
                            {% for error in form.role.errors %}
                                <div class="error">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" id="id_status">
                            <option value="active" selected>Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Password</label>
                    <input type="password" 
                           class="form-input {% if form.password.errors %}error{% endif %}" 
                           name="password" 
                           id="id_password"
                           placeholder="Enter secure password">
                    {% if form.password.errors %}
                        {% for error in form.password.errors %}
                            <div class="error">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="modal-footer">
                    <a href="{% url 'monitoring:user_management' %}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Close modal when clicking outside
    const modalOverlay = document.querySelector('.modal-overlay');
    const modalContainer = document.querySelector('.modal-container');
    
    modalOverlay.addEventListener('click', function(e) {
        if (e.target === modalOverlay) {
            window.location.href = "{% url 'monitoring:user_management' %}";
        }
    });
    
    // Prevent modal from closing when clicking inside content
    modalContainer.addEventListener('click', function(e) {
        e.stopPropagation();
    });
    
    // Form validation
    const form = document.getElementById('addUserForm');
    form.addEventListener('submit', function(e) {
        const requiredFields = ['first_name', 'email', 'username', 'password', 'role'];
        let hasErrors = false;
        
        // Clear previous errors
        clearFormErrors();
        
        requiredFields.forEach(function(fieldName) {
            const field = document.getElementById('id_' + fieldName);
            
            if (!field.value.trim()) {
                field.classList.add('error');
                showFieldError(field, 'This field is required.');
                hasErrors = true;
            }
        });
        
        if (hasErrors) {
            e.preventDefault();
            showToast('Please fill in all required fields', 'error');
        } else {
            // Show success message before form submission
            const userName = document.getElementById('id_first_name').value || document.getElementById('id_username').value;
            showToast(`Creating user "${userName}"...`, 'info');
        }
    });
    
    // Remove error styling when user starts typing
    const inputs = document.querySelectorAll('.form-input, .form-select');
    inputs.forEach(function(input) {
        input.addEventListener('input', function() {
            this.classList.remove('error');
            const errorDiv = this.parentNode.querySelector('.error:not([class*="form"])');
            if (errorDiv && !errorDiv.textContent.includes('already exists')) {
                errorDiv.remove();
            }
        });
    });

    // Initialize with success message
    showToast('User management form loaded', 'success');
});

// Helper functions
function clearFormErrors() {
    const inputs = document.querySelectorAll('.form-input, .form-select');
    inputs.forEach(function(input) {
        input.classList.remove('error');
    });
    
    const dynamicErrors = document.querySelectorAll('.error:not([class*="form"])');
    dynamicErrors.forEach(function(error) {
        if (!error.textContent.includes('already exists')) {
            error.remove();
        }
    });
}

function showFieldError(field, message) {
    const existingError = field.parentNode.querySelector('.error:not([class*="form"])');
    if (!existingError) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = message;
        field.parentNode.appendChild(errorDiv);
    }
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        window.location.href = "{% url 'monitoring:user_management' %}";
    }
});
</script>
{% endblock %}